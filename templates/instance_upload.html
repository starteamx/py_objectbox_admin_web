{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.upload-area {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
}

.status-monitor {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    display: none;
}

.status-item {
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>实例 #{{ instance.id }} - 文件上传</h2>
    
    <!-- 上传表单 -->
    <div class="card" id="uploadCard">
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" name="instance_id" value="{{ instance.id }}">
                <div class="mb-3">
                    <label for="file" class="form-label">选择 .mdb 文件</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".mdb" required>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    上传并启动
                </button>
            </form>
            <div class="alert alert-danger mt-3 d-none" id="errorAlert"></div>
        </div>
    </div>

    <!-- 状态监控区域 -->
    <div class="status-monitor" id="statusMonitor">
        <h4>实例状态监控</h4>
        <div class="status-item">
            <strong>连接状态:</strong> <span id="connectionStatus">未连接</span>
        </div>
        <div class="alert alert-info mt-3">
            ObjectBox Admin 已在新窗口打开。保持此页面打开以维持实例运行。
        </div>
    </div>
</div>

<script src="{{ url_for('static', path='js/instance-monitor.js') }}"></script>
<script>
document.getElementById('uploadForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const errorAlert = document.getElementById('errorAlert');
    
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    errorAlert.classList.add('d-none');
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: new FormData(this)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            document.getElementById('uploadCard').style.display = 'none';
            document.getElementById('statusMonitor').style.display = 'block';
            
            const monitor = new InstanceMonitor({{ instance.id }}, result.ws_url);
            monitor.openAdminWindow(result.url);
        } else {
            errorAlert.textContent = result.detail || '上传失败';
            errorAlert.classList.remove('d-none');
        }
    } catch (error) {
        errorAlert.textContent = '上传失败: ' + error.message;
        errorAlert.classList.remove('d-none');
    } finally {
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    }
};
</script>
{% endblock %} 