{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
.upload-area {
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.instance-info {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.status-badge {
    font-size: 1rem;
}

.timer-display {
    font-size: 1.2rem;
    color: #666;
    margin: 10px 0;
}

.progress {
    height: 5px;
    margin: 10px 0;
}

#uploadButton {
    display: none;
    margin-top: 10px;
}

.selected-file {
    margin-top: 10px;
    padding: 10px;
    background-color: #e9ecef;
    border-radius: 4px;
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>实例 #{{ instance.id }} - 文件上传</h2>
    <div class="card">
        <div class="card-body">
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="hidden" name="instance_id" value="{{ instance.id }}">
                <div class="mb-3">
                    <label for="file" class="form-label">选择 .mdb 文件</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".mdb" required>
                </div>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    上传并启动
                </button>
            </form>
            <div class="alert alert-danger mt-3 d-none" id="errorAlert"></div>
        </div>
    </div>
</div>

<script>
document.getElementById('uploadForm').onsubmit = async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const spinner = submitBtn.querySelector('.spinner-border');
    const errorAlert = document.getElementById('errorAlert');
    
    // 显示加载状态
    submitBtn.disabled = true;
    spinner.classList.remove('d-none');
    errorAlert.classList.add('d-none');
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // 成功后跳转
            window.location.href = result.url;
        } else {
            // 处理错误响应
            let errorMessage = '上传失败';
            if (result.detail) {
                errorMessage = typeof result.detail === 'object' 
                    ? JSON.stringify(result.detail) 
                    : result.detail;
            }
            errorAlert.textContent = errorMessage;
            errorAlert.classList.remove('d-none');
        }
    } catch (error) {
        // 显示错误信息
        errorAlert.textContent = '上传失败: ' + error.message;
        errorAlert.classList.remove('d-none');
    } finally {
        // 恢复按钮状态
        submitBtn.disabled = false;
        spinner.classList.add('d-none');
    }
};
</script>
{% endblock %} 