{% extends "base.html" %}

{% block title %}实例状态{% endblock %}

{% block extra_css %}
<style>
.instance-card {
    transition: all 0.3s ease;
    height: 100%;
}

.instance-card .card-body {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 1.5rem;
}

.instance-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.status-badge {
    position: absolute;
    top: 10px;
    right: 10px;
}

.instance-timer {
    font-size: 0.9rem;
    color: #666;
    margin-top: auto;
    padding-top: 1rem;
}

.progress {
    height: 5px;
}

.action-buttons {
    margin-top: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>实例状态</h2>
    <div class="row">
        {% for instance in instances %}
        <div class="col-md-4 mb-4">
            <div class="card instance-card" id="instance-{{ instance.instance_id }}">
                <div class="card-body">
                    <h5 class="card-title">实例 #{{ instance.instance_id }}</h5>
                    
                    {% if instance.status.value == 1 %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-circle"></i>
                            该实例正在使用中
                            <div class="small mt-2">
                                启动时间: {{ instance.start_time_text }}<br>
                                最后活跃: {{ instance.last_active_text }}
                            </div>
                        </div>
                    {% else %}
                        <p class="card-text">
                            状态: <span class="badge bg-success">可用</span>
                        </p>
                        <div class="action-buttons">
                            <a href="/instance/{{ instance.instance_id }}" 
                               class="btn btn-success">
                                启动实例
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Help Modal -->
<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">使用说明</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>实例状态说明:</h6>
                <ul>
                    <li><span class="badge bg-success">运行中</span> - 实例已启动，可以访问</li>
                    <li><span class="badge bg-secondary">空闲</span> - 实例可以启动使用</li>
                </ul>
                <h6>操作说明:</h6>
                <ul>
                    <li><strong>启动实例</strong> - 启动一个新的实例</li>
                    <li><strong>访问实例</strong> - 在新标签页中打开实例</li>
                </ul>
                <p class="text-muted mt-3">注意: 实例在30分钟无操作后将自动停止</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class InstanceStatusMonitor {
    constructor(interval = 5000) {  // 默认5秒刷新一次
        this.interval = interval;
        this.timer = null;
        this.startPolling();
    }

    async updateStatus() {
        try {
            const response = await fetch('/api/instances/status');
            const instances = await response.json();
            
            instances.forEach(instance => {
                const card = document.querySelector(`#instance-${instance.instance_id}`);
                if (card) {
                    if (instance.status === 1) {  // 运行中
                        card.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">实例 #${instance.instance_id}</h5>
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-circle"></i>
                                    该实例正在使用中
                                    <div class="small mt-2">
                                        启动时间: ${instance.start_time_text}<br>
                                        最后活跃: ${instance.last_active_text}
                                    </div>
                                </div>
                            </div>`;
                    } else {  // 空闲
                        card.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">实例 #${instance.instance_id}</h5>
                                <p class="card-text">
                                    状态: <span class="badge bg-success">可用</span>
                                </p>
                                <div class="action-buttons">
                                    <a href="/instance/${instance.instance_id}" 
                                       class="btn btn-success">
                                        启动实例
                                    </a>
                                </div>
                            </div>`;
                    }
                }
            });
        } catch (error) {
            console.error('Failed to update instance status:', error);
        }
    }

    startPolling() {
        this.updateStatus();  // 立即执行一次
        this.timer = setInterval(() => this.updateStatus(), this.interval);
    }

    stopPolling() {
        if (this.timer) {
            clearInterval(this.timer);
            this.timer = null;
        }
    }
}

// 启动状态监控
const statusMonitor = new InstanceStatusMonitor();

// 页面隐藏时停止轮询，显示时恢复
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        statusMonitor.stopPolling();
    } else {
        statusMonitor.startPolling();
    }
});
</script>
{% endblock %}